name: Persistent Pterodactyl VPS (FIXED)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 356

    steps:
    - uses: actions/checkout@v4

    # ---------- RESTORE ----------
    - name: Download Backup
      uses: actions/download-artifact@v4
      with:
        name: full-backup
        path: /tmp/backup
      continue-on-error: true

    - name: Restore Backup
      run: |
        if [ -f /tmp/backup/system.tar.gz ]; then
          sudo tar -xzf /tmp/backup/system.tar.gz -C /
        fi

    # ---------- UPDATE ----------
    - name: System Update
      run: |
        sudo apt update
        sudo apt upgrade -y

    # ---------- CLOUDFLARED ----------
    - name: Install Cloudflared
      run: |
        sudo mkdir -p --mode=0755 /usr/share/keyrings
        curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg \
        | sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null
        echo "deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main" \
        | sudo tee /etc/apt/sources.list.d/cloudflared.list
        sudo apt update
        sudo apt install -y cloudflared

    - name: Start Cloudflare Tunnel
      run: |
        sudo cloudflared service install eyJhIjoiMGViNjE3Y2Q5NzA3ZmU5ZGU0MjJiOGYxZTc4NDc0NTIiLCJ0IjoiNWI5MDVlYmUtMTFlZC00OTQ1LTg5N2EtMzk5ZDVlZDI5NTA4IiwicyI6IlkyUm1PR1kxTkdFdE5XVTRNeTAwWTJSaExUZ3lPR1l0TWpaaVpqY3laREZrTUdSbSJ9 || true

    - name: Set root password
      run: echo "root:nissalnodes" | sudo chpasswd

    # ---------- KEEP VPS ALIVE ----------
    - name: Keep VPS Alive
      run: sleep 21360   # 5h 56m

    # ---------- BACKUP ----------
    - name: Backup Pterodactyl & System
      run: |
        sudo mkdir -p /backup
        sudo tar -czf /backup/system.tar.gz \
          --exclude=/proc \
          --exclude=/sys \
          --exclude=/dev \
          --exclude=/tmp \
          --exclude=/run \
          /etc/pterodactyl \
          /var/lib/pterodactyl \
          /var/www/pterodactyl \
          /root

    - name: Upload Backup
      uses: actions/upload-artifact@v4
      with:
        name: full-backup
        path: /backup/system.tar.gz

    # ---------- OPTIONAL TMATE (LAST, NON-BLOCKING USE) ----------
    - name: Start tmate (manual only)
      if: github.event_name == 'workflow_dispatch'
      uses: mxschmitt/action-tmate@v3
